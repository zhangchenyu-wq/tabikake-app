<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tabi-Kake Cloud API</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>body { font-family: 'Noto Sans JP', sans-serif; }</style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // è¨­å®šï¼šAPIã‚­ãƒ¼ã¨ã‚¹ãƒ—ã‚·ãƒ»GASã®URL
        const API_KEY = "4ddbeb9beffd3a63b3b5bd6b";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz_UbkoSm2OrC1Nq7D0i8sejNNF5fEur3b2h0LJ92C7lpv6iE_8-76XPHr1o-CBKI4/exec";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1_iuHiQMSq31JqiKxy8RyxpeRToVwxGup2_c8XKXsaEE/edit?usp=sharing";

        function App() {
            const [tab, setTab] = useState('input');
            const [expenses, setExpenses] = useState([]);
            const [rates, setRates] = useState({ UZS: 0.012, KZT: 0.33, CNY: 21.0, JPY: 1 });
            const [lastUpdate, setLastUpdate] = useState("");
            
            const [item, setItem] = useState('');
            const [amount, setAmount] = useState('');
            const [currency, setCurrency] = useState('UZS');
            const [payer, setPayer] = useState('ã¡ã‚‡ã†ãã‚“');
            const [isShared, setIsShared] = useState(true);
            const [isSaving, setIsSaving] = useState(false);

            const fetchLatestRates = async () => {
                try {
                    const response = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/JPY`);
                    const data = await response.json();
                    if (data.result === "success") {
                        setRates({
                            UZS: 1 / data.conversion_rates.UZS,
                            KZT: 1 / data.conversion_rates.KZT,
                            CNY: 1 / data.conversion_rates.CNY,
                            JPY: 1
                        });
                        setLastUpdate(new Date().toLocaleTimeString());
                    }
                } catch (e) { console.error("ãƒ¬ãƒ¼ãƒˆå–å¾—å¤±æ•—"); }
            };

            const fetchHistory = async () => {
                try {
                    const res = await fetch(GAS_URL);
                    const data = await res.json();
                    const formatted = data.map(d => ({
                        ...d,
                        id: Math.random().toString(),
                        isShared: d["åˆ†é¡(å…±é€š/å€‹åˆ¥)"] === "å…±é€š",
                        amountJPY: Number(d["æ—¥æœ¬å††æ›ç®—"]) || 0
                    })).reverse();
                    setExpenses(formatted);
                } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—"); }
            };

            useEffect(() => {
                fetchLatestRates();
                fetchHistory();
            }, []);

            const addAndSyncExpense = async () => {
                if (!item || !amount || isSaving) return;
                setIsSaving(true);
                const jpy = Math.round(parseFloat(amount) * (rates[currency] || 1));
                const newExpense = {
                    date: new Date().toLocaleString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
                    payer: payer,
                    category: isShared ? "å…±é€š" : "å€‹åˆ¥",
                    item: item,
                    amountLabel: `${Number(amount).toLocaleString()} ${currency}`,
                    amountJPY: jpy,
                    isShared: isShared 
                };

                try {
                    await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(newExpense) });
                    setExpenses([ { ...newExpense, id: Date.now() }, ...expenses]);
                    setItem(''); setAmount('');
                    alert("ä¿å­˜å®Œäº†ï¼");
                } catch (e) {
                    alert("ä¿å­˜å¤±æ•—ã€‚");
                } finally {
                    setIsSaving(false);
                }
            };

            const stats = useMemo(() => {
                let choPaid = 0, naPaid = 0;
                expenses.forEach(e => {
                    if (e.isShared) {
                        if (e.payer === 'ã¡ã‚‡ã†ãã‚“') choPaid += e.amountJPY;
                        else naPaid += e.amountJPY;
                    }
                });
                return { diff: ((choPaid + naPaid) / 2) - choPaid };
            }, [expenses]);

            return (
                <div className="max-w-md mx-auto min-h-screen pb-10 shadow-2xl bg-white">
                    <div className="bg-slate-900 text-white p-6 rounded-b-[2rem]">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-xl font-black">Tabi-Kake API</h1>
                            <div className="flex gap-2">
                                <a 
                                    href={SHEET_URL} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="text-[10px] bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded-full font-bold transition-colors flex items-center gap-1"
                                >
                                    ğŸ“Š ã‚¹ãƒ—ã‚·ã‚’é–‹ã
                                </a>
                                <button onClick={fetchHistory} className="text-[10px] bg-white/20 px-3 py-1.5 rounded-full font-bold">æ›´æ–°</button>
                            </div>
                        </div>
                        <div className="bg-white/10 rounded-2xl p-4 backdrop-blur-md border border-white/10">
                            <p className="text-[10px] font-bold text-slate-400 mb-1">ç¾åœ¨ã®ç²¾ç®—ï¼ˆå…±é€šåˆ†ï¼‰</p>
                            <div className="text-xl font-black">
                                {stats.diff > 0 ? 
                                    <span className="text-orange-400">ã¡ã‚‡ã† â†’ ãªãƒ¼ï¼š{Math.abs(Math.round(stats.diff)).toLocaleString()}å††</span> : 
                                    <span className="text-emerald-400">ãªãƒ¼ â†’ ã¡ã‚‡ã†ï¼š{Math.abs(Math.round(stats.diff)).toLocaleString()}å††</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div className="flex p-4 gap-2">
                        <button onClick={() => setTab('input')} className={`flex-1 py-3 rounded-xl font-bold transition-all ${tab === 'input' ? 'bg-indigo-900 text-white shadow-lg' : 'bg-slate-100 text-slate-400'}`}>å…¥åŠ›</button>
                        <button onClick={() => setTab('check')} className={`flex-1 py-3 rounded-xl font-bold transition-all ${tab === 'check' ? 'bg-indigo-900 text-white shadow-lg' : 'bg-slate-100 text-slate-400'}`}>å±¥æ­´</button>
                    </div>

                    <main className="px-4 space-y-4">
                        {tab === 'input' ? (
                            <div className="space-y-4">
                                <input value={item} onChange={e => setItem(e.target.value)} placeholder="åº—åãƒ»å†…å®¹" className="w-full p-4 bg-slate-50 rounded-2xl text-lg font-bold outline-none border-none focus:ring-2 ring-indigo-500" />
                                <div className="flex gap-2">
                                    <input type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="é‡‘é¡" className="flex-[2] p-4 bg-slate-50 rounded-2xl text-lg font-black outline-none border-none focus:ring-2 ring-indigo-500" />
                                    <select value={currency} onChange={e => setCurrency(e.target.value)} className="flex-1 p-4 bg-slate-50 rounded-2xl font-bold border-none appearance-none">
                                        {Object.keys(rates).map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    {['ã¡ã‚‡ã†ãã‚“', 'ãªãƒ¼ã¡ã‚ƒã‚“'].map(p => (
                                        <button key={p} onClick={() => setPayer(p)} className={`p-4 rounded-2xl font-bold border-2 transition-all ${payer === p ? 'border-indigo-900 bg-indigo-900 text-white shadow-md' : 'border-slate-100 text-slate-400 bg-white'}`}>{p}</button>
                                    ))}
                                </div>
                                <div className="flex bg-slate-100 p-1 rounded-2xl">
                                    <button onClick={() => setIsShared(true)} className={`flex-1 py-3 rounded-xl font-bold text-sm ${isShared ? 'bg-white shadow-sm text-indigo-900' : 'text-slate-400'}`}>å…±é€š</button>
                                    <button onClick={() => setIsShared(false)} className={`flex-1 py-3 rounded-xl font-bold text-sm ${!isShared ? 'bg-white shadow-sm text-indigo-900' : 'text-slate-400'}`}>å€‹åˆ¥</button>
                                </div>
                                <button onClick={addAndSyncExpense} disabled={isSaving} className={`w-full py-5 rounded-3xl font-black text-xl shadow-xl transition-all ${isSaving ? 'bg-slate-300' : 'bg-emerald-500 text-white active:scale-95'}`}>
                                    {isSaving ? "ä¿å­˜ä¸­..." : "ä¿å­˜ã—ã¦ã‚¹ãƒ—ã‚·ã«é€ã‚‹"}
                                </button>
                                <div className="p-3 bg-slate-50 rounded-xl text-[10px] text-slate-400 font-bold uppercase">
                                    <p className="mb-1">é©ç”¨ãƒ¬ãƒ¼ãƒˆ: {lastUpdate}</p>
                                    <div className="flex gap-4">
                                        {Object.entries(rates).filter(([k])=>k!=='JPY').map(([k,v]) => <span key={k}>{k}: Â¥{v.toFixed(3)}</span>)}
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {expenses.map(e => (
                                    <div key={e.id} className="p-4 bg-white border border-slate-100 rounded-2xl flex justify-between items-center shadow-sm">
                                        <div>
                                            <p className="font-bold text-slate-800 text-sm">{e.item || e["åº—å/å†…å®¹"]}</p>
                                            <p className="text-[10px] text-slate-400 font-bold">{e.payer || e["æ”¯æ‰•ã£ãŸäºº"]} â€¢ {e.category || e["åˆ†é¡(å…±é€š/å€‹åˆ¥)"]} â€¢ {e.amountLabel || e["ç¾åœ°é€šè²¨é¡"]}</p>
                                        </div>
                                        <p className="font-black text-indigo-900">Â¥{(e.amountJPY || 0).toLocaleString()}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>